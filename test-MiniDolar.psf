// WDOFUT 21N 58,82 % Max de 3 Loss seguidos //
input
  periodo(14);
  tipo_rsi(0);
  horario_de_inicio(0902);
  horario_de_fim(1700);
var
  fBoolUpper : Float;
  fBoolLower : Float;
  OB1        : Float;
  OB2        : Float;
  BollOsc    : Float;
  xmf        : Float;
  xrsi       : Float;
  stoc       : Float;
  marron     : Float;
  verde      : Float;
  oscp       : Float;
  avg        : Float;
  stopLoss   : Float;
  takeProfit : Float;
  nValue1    : Float;
  nValue2    : Float;
  nFish      : Float;
  div        : Float;
  fMACD      : Float;
  f1MACD     : Float;
  cache      : Float;
Inicio
  stopLoss := 15.0;
  takeProfit := 20.0;
  xrsi := RSI(periodo,tipo_rsi);
  xmf := MoneyFlowIndex(periodo);
  fBoolUpper := BollingerBands(2.0,20,0)|0|;
  fBoolLower := BollingerBands(2.0,20,0)|1|;
  OB1 := (fBoolUpper + fBoolLower) / 2.0;
  OB2 := fBoolUpper - fBoolLower;
  stoc := SlowStochastic(21);
  fMACD := MACD(26,16,9)|0|;
  f1MACD := MACD(26,16,9)|1|;
  Se (Highest(MedianPrice,10) - Lowest(MedianPrice,10) = 0) então
    div := 1
  senão 
    div := Highest(MedianPrice,10) - Lowest(MedianPrice,10);
  nValue1 := 0.33 * 2 * ((MedianPrice - Lowest(MedianPrice,10)) / (div) - 0.5) + 0.67 * nValue1[1];
  Se (nValue1 > 0.99) então
    nValue2 := 0.999
  senão Se (nValue1 < - 0.99) então
    nValue2 := - 0.999
  senão 
    nValue2 := nValue1;
  nFish := (0.5 * log((1.0 + nValue2) / (1.0 - nValue2)) + 0.5 * nFish[1]) * 1.99;
  Se (OB2 >= 0) e (OB2 < 1) então
    Inicio
      OB2 := 1;
    Fim;
  Se (OB2 < 0) e (OB2 > - 1) então
    Inicio
      OB2 := - 1;
    Fim;BollOsc := ((WeightedClose - OB1) / OB2) * 100;
  oscp := PercentChange(Close,15) * 10000.0;
  marron := (xrsi + xmf + BollOsc + (stoc / 3.0)) / 2.0;
  verde := marron + oscp;
  avg := xAverage(marron,15);
  If (time > horario_de_inicio) and (time < horario_de_fim) then
    begin
      Se (avg <> marron) and (fMACD > 0.0) and (f1MACD > 0.0) and (verde > marron) then
        inicio
          se (BuyPosition = 0) e (SellPosition = 0) e não (HasPendingOrders) então
            inicio
              BuyAtMarket(1);
              cache := Close;
              PaintBar(clVerde);
           
              //BuyStop(BuyPrice, BuyPrice);
              fim;
              if (SellPosition = 1) then
              begin
                BuyToCoverAtMarket;
                
                Alert(clVerde);
              end;
              
              
            fim
          else if (avg <> marron) and (fMACD < 0.0) and (f1MACD < 0.0) and (verde < marron) then
            inicio
              se (BuyPosition = 0) e (SellPosition = 0) e não (HasPendingOrders) então
                inicio
                  SellShortAtMarket(1);
                  
                  //SellShortStop(AskPrice, AskPrice-2);
                  fim;
                  if (BuyPosition = 1) then
                  begin
                    Alert(clPurple);
                    SellShortAtMarket;
                    cache := Close;
                  end;
                  PaintBar(clPurple);
                  
                fim
              else 
                inicio
                  Paintbar(clBlue);
                  if (SellPosition = 1) then
                    begin
                    BuyAtMarket;
                    Alert(clVerde);
                    end;
                  if (BuyPosition = 1) then
                  begin
                    SellShortAtMarket;
                    Alert(clPurple);
                  end;
                fim;
            end;
          Se (SellPosition = 1) then
            inicio
              BuyToCoverStop(SellPrice + stopLoss,SellPrice + stopLoss);
              //BuyToCoverStop(SellPrice - takeProfit,SellPrice - takeProfit);
              fim;
              Se (BuyPosition = 1) then
                inicio
                  SellToCoverStop(BuyPrice - stopLoss,BuyPrice - stopLoss);
                  //SellToCoverStop(BuyPrice + takeProfit,BuyPrice + takeProfit);
                  fim;
                  se (time >= horario_de_fim) então
                    ClosePosition;
                  Plot(cache);
                  //Plot2(SellPrice);
                  //Plot3(verde);
                  //Plot4(avg);
                  SetPlotColor(1,clBranco);
                  SetPlotColor(2,clAmarelo);
                  setPlotColor(3,clVerde);
                  SetPlotColor(4,clAzul);
                Fim;
